name: Deploy (Self-hosted + Docker)

# í˜¼í•© ë°©ì‹: Self-hosted Runner + Docker
# - Self-hosted Runner: SSH ì ‘ì† ë¶ˆí•„ìš” (ì„œë²„ê°€ GitHubì— ì ‘ì†)
# - Docker: í™˜ê²½ ê²©ë¦¬, ë¹ ë¥¸ ë°°í¬, ì‰¬ìš´ ë¡¤ë°±
# - ë¡œì»¬ ë¹Œë“œ: GHCR ì—…ë¡œë“œ/ë‹¤ìš´ë¡œë“œ ì—†ì´ ì„œë²„ì—ì„œ ì§ì ‘ ë¹Œë“œ

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: self-hosted  # ì„œë²„ì— ì„¤ì¹˜ëœ runnerì—ì„œ ì‹¤í–‰

    steps:
    - name: Load .env
      run: |
        cat << 'EOF' > .env
        ${{ secrets.JAVA_ENV_FILE }}
        EOF

    # 1ë‹¨ê³„: ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: Checkout code
      uses: actions/checkout@v4

    # 2ë‹¨ê³„: Java í™˜ê²½ ì„¤ì •
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'gradle'

    # 3ë‹¨ê³„: Gradle ë¹Œë“œ ê¶Œí•œ ì„¤ì •
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # 4ë‹¨ê³„: ë¹Œë“œ (JAR íŒŒì¼ ìƒì„±)
    - name: Build with Gradle
      run: ./gradlew clean build -x test

    # 5ë‹¨ê³„: í…ŒìŠ¤íŠ¸ (ì„ íƒì‚¬í•­)
    - name: Run tests
      run: ./gradlew test
      continue-on-error: true

    # 6ë‹¨ê³„: .env íŒŒì¼ í™•ì¸
    - name: Check .env file
      run: |
        if [ ! -f .env ]; then
          echo "âŒ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
          echo "ì„œë²„ì— .env íŒŒì¼ì„ ìƒì„±í•´ì£¼ì„¸ìš”."
          exit 1
        fi
        echo "âœ… .env íŒŒì¼ í™•ì¸ë¨"

    # 7ë‹¨ê³„: ê¸°ì¡´ ì´ë¯¸ì§€ ë°±ì—… (ë¡¤ë°±ìš©)
    - name: Backup current Docker image
      run: |
        if docker image inspect tai_java_backend:latest >/dev/null 2>&1; then
          echo "Backing up current image..."
          docker tag tai_java_backend:latest tai_java_backend:backup 2>/dev/null || true
          echo "âœ… Backup created"
        else
          echo "No existing image to backup"
        fi

    # 8ë‹¨ê³„: Docker ì´ë¯¸ì§€ ë¹Œë“œ
    - name: Build Docker image
      run: |
        echo "Building Docker image..."
        docker build -t tai_java_backend:latest .
        echo "âœ… Docker image built successfully"

    # 9ë‹¨ê³„: ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
    - name: Stop existing containers
      run: |
        echo "Stopping existing containers..."
        docker compose down || true
        echo "âœ… Containers stopped"

    # 10ë‹¨ê³„: PostgreSQL ì‹œì‘ ë° í—¬ìŠ¤ì²´í¬
    - name: Start PostgreSQL
      run: |
        echo "Starting PostgreSQL..."
        docker compose up -d postgres

        # PostgreSQL í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° (ìµœëŒ€ 30ì´ˆ)
        echo "Waiting for PostgreSQL to be ready..."
        for i in {1..30}; do
          if docker compose exec -T postgres pg_isready -U ${POSTGRES_USER:-postgres} >/dev/null 2>&1; then
            echo "âœ… PostgreSQL is ready!"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "âŒ PostgreSQL failed to start!"
            docker compose logs postgres
            exit 1
          fi
          echo "Waiting... ($i/30)"
          sleep 1
        done

    # 11ë‹¨ê³„: ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
    - name: Start application
      run: |
        echo "Starting application..."
        docker compose up -d app
        echo "âœ… Application container started"

    # 12ë‹¨ê³„: í—¬ìŠ¤ì²´í¬
    - name: Health check
      run: |
        echo "Waiting for application to start..."
        sleep 20

        # í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ (ìµœëŒ€ 60ì´ˆ ëŒ€ê¸°)
        for i in {1..12}; do
          if curl -f http://localhost:8080/actuator/health 2>/dev/null; then
            echo "âœ… Application is healthy!"
            echo "Application URL: http://localhost:8080"
            exit 0
          fi
          echo "Waiting for health check... ($i/12)"
          sleep 5
        done

        echo "âŒ Health check failed!"
        echo "=== Application logs ==="
        docker compose logs app --tail 50

        exit 1

    # 13ë‹¨ê³„: ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
    - name: Rollback on failure
      if: failure()
      run: |
        echo "âš ï¸ Deployment failed! Rolling back..."

        # ì‹¤íŒ¨í•œ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
        docker compose down || true

        # ë°±ì—… ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ë³µêµ¬
        if docker image inspect tai_java_backend:backup >/dev/null 2>&1; then
          echo "Restoring backup image..."
          docker tag tai_java_backend:backup tai_java_backend:latest

          # ë°±ì—… ì´ë¯¸ì§€ë¡œ ì¬ì‹œì‘
          docker compose up -d

          # í—¬ìŠ¤ì²´í¬
          sleep 10
          if curl -f http://localhost:8080/actuator/health 2>/dev/null; then
            echo "âœ… Rollback completed! Previous version is running."
          else
            echo "âš ï¸ Rollback completed but health check failed."
            echo "Manual intervention may be required."
          fi
        else
          echo "âš ï¸ No backup image found."
          echo "Manual intervention required."
        fi

    # 14ë‹¨ê³„: ì •ë¦¬ (ì„±ê³µ ì‹œ)
    - name: Clean up old images
      if: success()
      run: |
        # ë°±ì—… ì´ë¯¸ì§€ ì •ë¦¬
        docker image rm tai_java_backend:backup 2>/dev/null || true

        # dangling ì´ë¯¸ì§€ ì •ë¦¬
        docker image prune -f --filter "dangling=true" || true

        echo "âœ… Cleanup completed!"

    # 15ë‹¨ê³„: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
    - name: Deployment summary
      if: success()
      run: |
        echo "=========================================="
        echo "ğŸ‰ Deployment Successful!"
        echo "=========================================="
        echo "Service: Java Backend (Spring Boot)"
        echo "Port: 8080"
        echo "Health: http://localhost:8080/actuator/health"
        echo "=========================================="
        docker compose ps
        echo "=========================================="
